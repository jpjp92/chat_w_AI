import streamlit as st
import google.generativeai as genai
import os
from datetime import datetime
import json
import requests
from bs4 import BeautifulSoup
import re
import logging
from youtube_transcript_api import YouTubeTranscriptApi
from urllib.parse import urlparse, parse_qs
from pypdf import PdfReader
import io
from PIL import Image
import base64
from config.env import GEMINI_API_KEY

# ë¡œê¹… ì„¤ì •
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# --- í˜ì´ì§€ ì„¤ì • ---
st.set_page_config(
    page_title="Chat with Gemini",
    page_icon="ğŸš€",
    layout="wide"
)

# --- Gemini API ì„¤ì • ---
if not GEMINI_API_KEY:
    st.error("âŒ GEMINI_API_KEYê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. Streamlit Secrets ë˜ëŠ” config/env.pyë¥¼ í™•ì¸í•˜ì„¸ìš”.")
    st.stop()

try:
    genai.configure(api_key=GEMINI_API_KEY)
except Exception as e:
    st.error(f"âŒ API í‚¤ ì˜¤ë¥˜: {e}")
    st.stop()

# --- ê¸°ì¡´ í•¨ìˆ˜ë“¤ (ì´ë¯¸ì§€, ìœ íŠœë¸Œ, ì›¹í˜ì´ì§€, PDF ì²˜ë¦¬ ë“±) ---
def validate_image_file(uploaded_file):
    """ì—…ë¡œë“œëœ ì´ë¯¸ì§€ íŒŒì¼ ìœ íš¨ì„± ê²€ì‚¬"""
    supported_types = ['image/png', 'image/jpeg', 'image/webp']
    if uploaded_file.type not in supported_types:
        return False, f"ì§€ì›ë˜ì§€ ì•ŠëŠ” ì´ë¯¸ì§€ í˜•ì‹ì…ë‹ˆë‹¤. ì§€ì› í˜•ì‹: PNG, JPEG, WebP"
    max_size = 7 * 1024 * 1024  # 7MB
    if uploaded_file.size > max_size:
        return False, f"ì´ë¯¸ì§€ í¬ê¸°ê°€ ë„ˆë¬´ í½ë‹ˆë‹¤. ìµœëŒ€ í¬ê¸°: 7MB, í˜„ì¬ í¬ê¸°: {uploaded_file.size / (1024*1024):.1f}MB"
    return True, "ìœ íš¨í•œ ì´ë¯¸ì§€ íŒŒì¼ì…ë‹ˆë‹¤."

def process_image_for_gemini(uploaded_file):
    """Gemini APIìš© ì´ë¯¸ì§€ ì²˜ë¦¬"""
    try:
        image = Image.open(uploaded_file)
        logger.info(f"ì´ë¯¸ì§€ í¬ê¸°: {image.size}, ëª¨ë“œ: {image.mode}, í˜•ì‹: {image.format}")
        return image
    except Exception as e:
        logger.error(f"ì´ë¯¸ì§€ ì²˜ë¦¬ ì˜¤ë¥˜: {str(e)}")
        return None

def analyze_image_with_gemini(images, user_query, chat_session, detected_lang):
    """Geminië¡œ ì´ë¯¸ì§€ ë¶„ì„ (ë‹¤ì¤‘ ì´ë¯¸ì§€ ì§€ì›)"""
    try:
        system_prompt = get_system_prompt(detected_lang)
        if detected_lang == "ko":
            prompt = f"""{system_prompt}

ë‹¤ìŒ ì´ë¯¸ì§€ë“¤ì„ ë¶„ì„í•´ì£¼ì„¸ìš”.

ì‚¬ìš©ì ì§ˆë¬¸: {user_query}

ë¶„ì„ ì§€ì¹¨:
1. ê° ì´ë¯¸ì§€ì— ë³´ì´ëŠ” ì£¼ìš” ìš”ì†Œë“¤ì„ ì„¤ëª…
2. ì´ë¯¸ì§€ë“¤ ê°„ì˜ ê´€ê³„ë‚˜ ê³µí†µì , ì°¨ì´ì  ë¶„ì„
3. ìƒ‰ìƒ, êµ¬ë„, ìŠ¤íƒ€ì¼ ë“±ì˜ ì‹œê°ì  íŠ¹ì§•
4. í…ìŠ¤íŠ¸ê°€ ìˆë‹¤ë©´ ì½ì–´ì„œ ë‚´ìš© ì„¤ëª…
5. ì‚¬ìš©ìì˜ íŠ¹ì • ì§ˆë¬¸ì´ ìˆë‹¤ë©´ ê·¸ì— ë§ì¶° ë¶„ì„
6. ì´ëª¨ì§€ë¥¼ ì ì ˆíˆ ì‚¬ìš©í•˜ì—¬ ê°€ë…ì„± í–¥ìƒ
7. ë°˜ë“œì‹œ í•œêµ­ì–´ë¡œë§Œ ë‹µë³€í•˜ì„¸ìš”

í˜•ì‹:
ğŸ“¸ **ì´ë¯¸ì§€ ë¶„ì„ ê²°ê³¼**

ğŸ” **ì£¼ìš” ìš”ì†Œ**:
- ì´ë¯¸ì§€ 1: ...
- ì´ë¯¸ì§€ 2: ...
- ...

ğŸ¨ **ì‹œê°ì  íŠ¹ì§•**:
- ...

ğŸ“ **í…ìŠ¤íŠ¸ ë‚´ìš©** (ìˆëŠ” ê²½ìš°):
- ...

ğŸ’¡ **ì¶”ê°€ ë¶„ì„**:
- ...
"""
        else:
            prompt = f"""{system_prompt}

Please analyze the following images.

User Query: {user_query}

Analysis Guidelines:
1. Describe the main elements visible in each image
2. Analyze relationships, commonalities, or differences between images
3. Include visual features such as colors, composition, style
4. If there's text, read and describe the content
5. Focus on user's specific question if provided
6. Use appropriate emojis for readability
7. Respond only in English

Format:
ğŸ“¸ **Image Analysis Result**

ğŸ” **Main Elements**:
- Image 1: ...
- Image 2: ...
- ...

ğŸ¨ **Visual Features**:
- ...

ğŸ“ **Text Content** (if any):
- ...

ğŸ’¡ **Additional Analysis**:
- ...
"""
        message_content = [prompt] + images
        response = chat_session.send_message(message_content)
        return response.text
    except Exception as e:
        logger.error(f"ì´ë¯¸ì§€ ë¶„ì„ ì¤‘ ì˜¤ë¥˜: {str(e)}")
        return f"âŒ ì´ë¯¸ì§€ ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {str(e)}"

def is_image_analysis_request(query, has_images):
    """ì´ë¯¸ì§€ ë¶„ì„ ìš”ì²­ì¸ì§€ í™•ì¸"""
    if not has_images:
        return False
    analysis_keywords = ['ë¶„ì„', 'ì„¤ëª…', 'ì•Œë ¤ì¤˜', 'ë¬´ì—‡', 'ë­', 'ì–´ë–¤', 'ë³´ì—¬ì¤˜', 'ì½ì–´ì¤˜', 'í•´ì„', 'ë¶„ì„í•´ì¤˜']
    return any(keyword in query for keyword in analysis_keywords)

def extract_video_id(url):
    """ìœ íŠœë¸Œ URLì—ì„œ ë¹„ë””ì˜¤ ID ì¶”ì¶œ (ì‡¼ì¸  í¬í•¨)"""
    try:
        if 'youtu.be/' in url:
            return url.split('youtu.be/')[1].split('?')[0]
        elif 'youtube.com/watch' in url:
            parsed_url = urlparse(url)
            return parse_qs(parsed_url.query)['v'][0]
        elif 'youtube.com/embed/' in url:
            return url.split('embed/')[1].split('?')[0]
        elif 'youtube.com/shorts/' in url:
            return url.split('shorts/')[1].split('?')[0]
        else:
            return None
    except:
        return None

def is_youtube_url(url):
    """ìœ íŠœë¸Œ URLì¸ì§€ í™•ì¸ (ì‡¼ì¸  í¬í•¨)"""
    youtube_domains = ['youtube.com', 'youtu.be', 'www.youtube.com']
    youtube_patterns = ['/watch', '/shorts/', '/embed/', 'youtu.be/']
    try:
        parsed_url = urlparse(url)
        domain_match = any(domain in parsed_url.netloc for domain in youtube_domains)
        pattern_match = any(pattern in url for pattern in youtube_patterns)
        return domain_match and pattern_match
    except:
        return False

def get_youtube_transcript(video_id):
    """ìœ íŠœë¸Œ ë¹„ë””ì˜¤ì˜ ìë§‰ ê°€ì ¸ì˜¤ê¸°"""
    try:
        try:
            transcript = YouTubeTranscriptApi.get_transcript(video_id, languages=['ko'])
        except:
            try:
                transcript = YouTubeTranscriptApi.get_transcript(video_id, languages=['en'])
            except:
                transcript = YouTubeTranscriptApi.get_transcript(video_id)
        full_text = ' '.join([entry['text'] for entry in transcript])
        max_chars = 15000
        if len(full_text) > max_chars:
            full_text = full_text[:max_chars] + "\n\n... (ìë§‰ì´ ê¸¸ì–´ì„œ ì¼ë¶€ë§Œ í‘œì‹œë©ë‹ˆë‹¤)"
        return full_text
    except Exception as e:
        logger.error(f"ìœ íŠœë¸Œ ìë§‰ ì¶”ì¶œ ì˜¤ë¥˜: {str(e)}")
        return None

def extract_urls_from_text(text):
    """í…ìŠ¤íŠ¸ì—ì„œ URLì„ ì¶”ì¶œ"""
    url_pattern = r'http[s]?://(?:[a-zA-Z]|[0-9]|[$-_@.&+]|[!*\\(\\),]|(?:%[0-9a-fA-F][0-9a-fA-F]))+'
    urls = re.findall(url_pattern, text)
    return urls

def is_youtube_summarization_request(query):
    """ìœ íŠœë¸Œ ìš”ì•½ ìš”ì²­ì¸ì§€ í™•ì¸"""
    urls = extract_urls_from_text(query)
    if urls:
        for url in urls:
            if is_youtube_url(url):
                summary_keywords = ['ìš”ì•½', 'ì •ë¦¬', 'ë‚´ìš©', 'ì„¤ëª…', 'ì•Œë ¤ì¤˜', 'ë¶„ì„', 'í•´ì„', 'ë¦¬ë·°', 'ì •ë³´']
                for keyword in summary_keywords:
                    if keyword in query:
                        return True, url
    return False, None

def summarize_youtube_with_gemini(url, user_query, model, detected_lang):
    """ìœ íŠœë¸Œ ë¹„ë””ì˜¤ë¥¼ Geminië¡œ ìš”ì•½"""
    try:
        video_id = extract_video_id(url)
        if not video_id:
            return "âŒ ìœ íš¨í•˜ì§€ ì•Šì€ ìœ íŠœë¸Œ URLì…ë‹ˆë‹¤."
        transcript = get_youtube_transcript(video_id)
        if not transcript:
            return "âŒ ì´ ìœ íŠœë¸Œ ë¹„ë””ì˜¤ì˜ ìë§‰ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
        system_prompt = get_system_prompt(detected_lang)
        if detected_lang == "ko":
            prompt = f"""{system_prompt}

ë‹¤ìŒ ìœ íŠœë¸Œ ë¹„ë””ì˜¤ì˜ ìë§‰ ë‚´ìš©ì„ í•œêµ­ì–´ë¡œ ìš”ì•½í•´ì£¼ì„¸ìš”.

ìœ íŠœë¸Œ URL: {url}
ì‚¬ìš©ì ì§ˆë¬¸: {user_query}

ë¹„ë””ì˜¤ ìë§‰ ë‚´ìš©:
{transcript}

ìš”ì•½ ì§€ì¹¨:
1. ë¹„ë””ì˜¤ì˜ ì£¼ìš” ë‚´ìš©ì„ 5-7ê°œ í¬ì¸íŠ¸ë¡œ ì •ë¦¬
2. ì¤‘ìš”í•œ ì •ë³´ë‚˜ í•µì‹¬ ë©”ì‹œì§€ë¥¼ í¬í•¨
3. ì‹œê°„ ìˆœì„œëŒ€ë¡œ ë‚´ìš© êµ¬ì„±
4. ì‚¬ìš©ìê°€ íŠ¹ì • ì§ˆë¬¸ì„ í–ˆë‹¤ë©´ ê·¸ì— ë§ì¶° ìš”ì•½
5. ì´ëª¨ì§€ë¥¼ ì ì ˆíˆ ì‚¬ìš©í•˜ì—¬ ê°€ë…ì„± í–¥ìƒ
6. ì¶œì²˜ URLë„ í•¨ê»˜ ì œê³µ
7. ë°˜ë“œì‹œ í•œêµ­ì–´ë¡œë§Œ ë‹µë³€í•˜ì„¸ìš”

í˜•ì‹:
ğŸ¬ **ìœ íŠœë¸Œ ë¹„ë””ì˜¤ ìš”ì•½**

ğŸ”— **ì¶œì²˜**: {url}

ğŸ“ **ì£¼ìš” ë‚´ìš©**:
- í•µì‹¬ í¬ì¸íŠ¸ 1
- í•µì‹¬ í¬ì¸íŠ¸ 2
- ...

ğŸ’¡ **ê²°ë¡ **: ë¹„ë””ì˜¤ì˜ í•µì‹¬ ë©”ì‹œì§€ë‚˜ ê²°ë¡ 
"""
        else:
            prompt = f"""{system_prompt}

Please summarize the following YouTube video transcript in English.

YouTube URL: {url}
User Query: {user_query}

Video Transcript:
{transcript}

Summary Guidelines:
1. Organize main content into 5-7 key points
2. Include important information and key messages
3. Structure content chronologically
4. Focus on user's specific question if provided
5. Use appropriate emojis for readability
6. Include source URL
7. Respond only in English

Format:
ğŸ¬ **YouTube Video Summary**

ğŸ”— **Source**: {url}

ğŸ“ **Key Points**:
- Main point 1
- Main point 2
- ...

ğŸ’¡ **Conclusion**: Key message or conclusion from the video
"""
        response = model.generate_content(prompt)
        return response.text
    except Exception as e:
        logger.error(f"ìœ íŠœë¸Œ ìš”ì•½ ì¤‘ ì˜¤ë¥˜: {str(e)}")
        return f"âŒ ìœ íŠœë¸Œ ìš”ì•½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {str(e)}"

def is_url_summarization_request(query):
    """URL ìš”ì•½ ìš”ì²­ì¸ì§€ í™•ì¸ (ìœ íŠœë¸Œ ë° PDF ì œì™¸)"""
    urls = extract_urls_from_text(query)
    if urls:
        for url in urls:
            if not is_youtube_url(url) and not is_pdf_url(url):
                summary_keywords = ['ìš”ì•½', 'ì •ë¦¬', 'ë‚´ìš©', 'ì„¤ëª…', 'ì•Œë ¤ì¤˜', 'ë¶„ì„', 'í•´ì„', 'ë¦¬ë·°', 'ì •ë³´']
                for keyword in summary_keywords:
                    if keyword in query:
                        return True, url
    return False, None

def fetch_webpage_content(url):
    """ì¼ë°˜ ì›¹í˜ì´ì§€ HTML ë‚´ìš© ì¶”ì¶œ"""
    try:
        headers = {'User-Agent': 'Mozilla/5.0'}
        response = requests.get(url, headers=headers, timeout=15)
        response.raise_for_status()
        soup = BeautifulSoup(response.content, 'html.parser')
        for tag in soup(['script', 'style', 'nav', 'header', 'footer', 'aside']):
            tag.decompose()
        main_content = soup.find('main') or soup.find('article') or soup.body
        text = main_content.get_text(strip=True, separator='\n') if main_content else soup.get_text(strip=True, separator='\n')
        clean_text = '\n'.join(line.strip() for line in text.split('\n') if line.strip())
        if len(clean_text) > 8000:
            clean_text = clean_text[:8000] + "\n\n... (ë‚´ìš©ì´ ê¸¸ì–´ì„œ ì¼ë¶€ë§Œ í‘œì‹œë©ë‹ˆë‹¤)"
        return clean_text
    except Exception as e:
        logger.error(f"ì›¹í˜ì´ì§€ ë‚´ìš© ì¶”ì¶œ ì˜¤ë¥˜: {str(e)}")
        return f"âŒ '{url}' ë‚´ìš©ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: {str(e)}"

def summarize_webpage_with_gemini(url, user_query, model, detected_lang):
    """ì›¹í˜ì´ì§€ ë‚´ìš©ì„ Geminië¡œ ìš”ì•½"""
    try:
        content = fetch_webpage_content(url)
        if content.startswith("âŒ"):
            return content
        system_prompt = get_system_prompt(detected_lang)
        if detected_lang == "ko":
            prompt = f"""{system_prompt}

ë‹¤ìŒ ì›¹í˜ì´ì§€ì˜ ë‚´ìš©ì„ í•œêµ­ì–´ë¡œ ìš”ì•½í•´ì£¼ì„¸ìš”.

ì›¹í˜ì´ì§€ URL: {url}
ì‚¬ìš©ì ì§ˆë¬¸: {user_query}

ì›¹í˜ì´ì§€ ë‚´ìš©:
{content}

ìš”ì•½ ì§€ì¹¨:
1. ì£¼ìš” í•µì‹¬ ë‚´ìš©ì„ 3-5ê°œ í¬ì¸íŠ¸ë¡œ ì •ë¦¬
2. ì¤‘ìš”í•œ ì •ë³´ë‚˜ ìˆ˜ì¹˜ê°€ ìˆë‹¤ë©´ í¬í•¨
3. ì‚¬ìš©ìê°€ íŠ¹ì • ì§ˆë¬¸ì„ í–ˆë‹¤ë©´ ê·¸ì— ë§ì¶° ìš”ì•½
4. ì´ëª¨ì§€ë¥¼ ì ì ˆíˆ ì‚¬ìš©í•˜ì—¬ ê°€ë…ì„± í–¥ìƒ
5. ì¶œì²˜ URLë„ í•¨ê»˜ ì œê³µ
6. ë°˜ë“œì‹œ í•œêµ­ì–´ë¡œë§Œ ë‹µë³€í•˜ì„¸ìš”

í˜•ì‹:
ğŸ“„ **ì›¹í˜ì´ì§€ ìš”ì•½**

ğŸ”— **ì¶œì²˜**: {url}

ğŸ“ **ì£¼ìš” ë‚´ìš©**:
- í•µì‹¬ í¬ì¸íŠ¸ 1
- í•µì‹¬ í¬ì¸íŠ¸ 2
- ...

ğŸ’¡ **ê²°ë¡ **: ê°„ë‹¨í•œ ê²°ë¡ ì´ë‚˜ í•µì‹¬ ë©”ì‹œì§€
"""
        else:
            prompt = f"""{system_prompt}

Please summarize the following webpage content in English.

Webpage URL: {url}
User Query: {user_query}

Webpage Content:
{content}

Summary Guidelines:
1. Organize main points into 3-5 key bullets
2. Include important information or numbers if present
3. Focus on user's specific question if provided
4. Use appropriate emojis for readability
5. Include source URL
6. Respond only in English

Format:
ğŸ“„ **Webpage Summary**

ğŸ”— **Source**: {url}

ğŸ“ **Key Points**:
- Main point 1
- Main point 2
- ...

ğŸ’¡ **Conclusion**: Brief conclusion or key message
"""
        response = model.generate_content(prompt)
        return response.text
    except Exception as e:
        logger.error(f"ì›¹í˜ì´ì§€ ìš”ì•½ ì¤‘ ì˜¤ë¥˜: {str(e)}")
        return f"âŒ ì›¹í˜ì´ì§€ ìš”ì•½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {str(e)}"

def is_pdf_url(url):
    """PDF URLì¸ì§€ í™•ì¸"""
    return url.lower().endswith('.pdf') or '/pdf/' in url

def is_pdf_summarization_request(query):
    """PDF ìš”ì•½ ìš”ì²­ì¸ì§€ í™•ì¸"""
    urls = extract_urls_from_text(query)
    if urls:
        for url in urls:
            if is_pdf_url(url):
                summary_keywords = ['ìš”ì•½', 'ì •ë¦¬', 'ë‚´ìš©', 'ì„¤ëª…', 'ì•Œë ¤ì¤˜', 'ë¶„ì„', 'í•´ì„', 'ë¦¬ë·°', 'ì •ë³´']
                for keyword in summary_keywords:
                    if keyword in query:
                        return True, url
    return False, None

def fetch_pdf_text(url, max_chars=8000):
    """PDF íŒŒì¼ì—ì„œ í…ìŠ¤íŠ¸ ì¶”ì¶œ"""
    try:
        response = requests.get(url, timeout=20)
        response.raise_for_status()
        pdf_file = io.BytesIO(response.content)
        reader = PdfReader(pdf_file)
        text = ""
        for page in reader.pages:
            text += page.extract_text() or ""
            if len(text) > max_chars:
                text = text[:max_chars] + "\n\n... (ë‚´ìš©ì´ ê¸¸ì–´ì„œ ì¼ë¶€ë§Œ í‘œì‹œë©ë‹ˆë‹¤)"
                break
        metadata = reader.metadata or {}
        return text.strip(), metadata
    except Exception as e:
        return f"âŒ PDF íŒŒì¼ì„ ì²˜ë¦¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤: {e}", None

def summarize_pdf_with_gemini(url, user_query, model, detected_lang):
    """PDF ë‚´ìš©ì„ Geminië¡œ ìš”ì•½"""
    try:
        content, metadata = fetch_pdf_text(url)
        if content.startswith("âŒ"):
            return content
        metadata_info = {
            "title": metadata.get("/Title", "Unknown") if metadata else "Unknown",
            "author": metadata.get("/Author", "Unknown") if metadata else "Unknown"
        }
        system_prompt = get_system_prompt(detected_lang)
        if detected_lang == "ko":
            prompt = f"""{system_prompt}

ë‹¤ìŒ PDF ë¬¸ì„œì˜ ë‚´ìš©ì„ í•œêµ­ì–´ë¡œ ìš”ì•½í•´ì£¼ì„¸ìš”.

PDF URL: {url}
PDF ì œëª©: {metadata_info["title"]}
ì‚¬ìš©ì ì§ˆë¬¸: {user_query}

PDF ë‚´ìš©:
{content}

ìš”ì•½ ì§€ì¹¨:
1. ì£¼ìš” ë‚´ìš©ì„ 3-5ê°œ í¬ì¸íŠ¸ë¡œ ì •ë¦¬
2. ì¤‘ìš”í•œ ë°ì´í„°ë‚˜ ê¸°ì—¬ë„ë¥¼ í¬í•¨
3. ì‚¬ìš©ìê°€ íŠ¹ì • ì§ˆë¬¸ì„ í–ˆë‹¤ë©´ ê·¸ì— ë§ì¶° ìš”ì•½
4. ì´ëª¨ì§€ë¥¼ ì ì ˆíˆ ì‚¬ìš©í•˜ì—¬ ê°€ë…ì„± í–¥ìƒ
5. ì¶œì²˜ URLê³¼ ì œëª© í¬í•¨
6. ë°˜ë“œì‹œ í•œêµ­ì–´ë¡œë§Œ ë‹µë³€í•˜ì„¸ìš”

í˜•ì‹:
ğŸ“„ **PDF ìš”ì•½**

ğŸ”— **ì¶œì²˜**: {url}
ğŸ“– **ì œëª©**: {metadata_info["title"]}
ğŸ“œ **ì €ì**: {metadata_info["author"]}

ğŸ“ **ì£¼ìš” ë‚´ìš©**:
- í¬ì¸íŠ¸ 1
- í¬ì¸íŠ¸ 2
- ...

ğŸ’¡ **í•µì‹¬**: ì£¼ìš” ë©”ì‹œì§€ë‚˜ ì˜ì˜
"""
        else:
            prompt = f"""{system_prompt}

Please summarize the following PDF document in English.

PDF URL: {url}
PDF Title: {metadata_info["title"]}
User Query: {user_query}

PDF Content:
{content}

Summary Guidelines:
1. Organize main points into 3-5 key bullets
2. Include important data or contributions
3. Focus on user's specific question if provided
4. Use appropriate emojis for readability
5. Include source URL and title
6. Respond only in English

Format:
ğŸ“„ **PDF Summary**

ğŸ”— **Source**: {url}
ğŸ“– **Title**: {metadata_info["title"]}
ğŸ“œ **Author**: {metadata_info["author"]}

ğŸ“ **Key Points**:
- Point 1
- Point 2
- ...

ğŸ’¡ **Key Insight**: Main message or significance
"""
        response = model.generate_content(prompt)
        return response.text
    except Exception as e:
        logger.error(f"PDF ìš”ì•½ ì¤‘ ì˜¤ë¥˜: {str(e)}")
        return f"âŒ PDF ìš”ì•½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {str(e)}"

def get_usage_count():
    """ì¼ì¼ ì‚¬ìš©ëŸ‰ ì¶”ì """
    today = datetime.now().strftime("%Y-%m-%d")
    if "usage_data" not in st.session_state:
        st.session_state.usage_data = {"date": today, "count": 0}
    if st.session_state.usage_data["date"] != today:
        st.session_state.usage_data = {"date": today, "count": 0}
    return st.session_state.usage_data["count"]

def increment_usage():
    """ì‚¬ìš©ëŸ‰ ì¦ê°€"""
    if "usage_data" in st.session_state:
        st.session_state.usage_data["count"] += 1
    else:
        today = datetime.now().strftime("%Y-%m-%d")
        st.session_state.usage_data = {"date": today, "count": 1}

def detect_language(text):
    """í…ìŠ¤íŠ¸ì—ì„œ URLì„ ì œì™¸í•˜ê³  ì–¸ì–´ ê°ì§€"""
    url_pattern = r'https?://[^\s]+'
    urls = re.findall(url_pattern, text)
    for url in urls:
        text = text.replace(url, '')
    text = text.strip()
    if not text:
        return "ko"
    korean_chars = sum(1 for char in text if '\uac00' <= char <= '\ud7af')
    total_chars = len(text.replace(' ', ''))
    korean_ratio = korean_chars / total_chars if total_chars > 0 else 0
    return "ko" if korean_ratio > 0.3 else "en"

def get_system_prompt(language):
    """ì–¸ì–´ë³„ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸"""
    if language == "ko":
        return """ë‹¹ì‹ ì€ ì¹œê·¼í•˜ê³  ë„ì›€ì´ ë˜ëŠ” AI ì–´ì‹œìŠ¤í„´íŠ¸ì…ë‹ˆë‹¤.
        ë‹¤ìŒ ê·œì¹™ì„ ë”°ë¼ì£¼ì„¸ìš”:
        - í•œêµ­ì–´ë¡œë§Œ ë‹µë³€í•˜ì„¸ìš”
        - ì¹œê·¼í•˜ê³  ìì—°ìŠ¤ëŸ¬ìš´ í†¤ì„ ì‚¬ìš©í•˜ì„¸ìš”
        - ì´ëª¨ì§€ë¥¼ ì ì ˆíˆ í™œìš©í•˜ì„¸ìš”
        - ì›¹í˜ì´ì§€, ìœ íŠœë¸Œ, PDF ìš”ì•½ ê¸°ëŠ¥ì„ ì œê³µí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
        - ì´ë¯¸ì§€ ë¶„ì„ ê¸°ëŠ¥ì„ ì œê³µí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
        - ë‹µë³€ì€ ê°„ê²°í•˜ë©´ì„œë„ ìœ ìš©í•˜ê²Œ ì‘ì„±í•˜ì„¸ìš”"""
    else:
        return """You are a friendly and helpful AI assistant.
        Please follow these rules:
        - Respond only in English
        - Use a friendly and natural tone
        - Use appropriate emojis
        - You can provide webpage, YouTube, and PDF summarization features
        - You can provide image analysis features
        - Keep responses concise yet useful"""

# --- ì‚¬ì´ë“œë°”: ì±„íŒ… ë‚´ì—­ í‘œì‹œ ---
with st.sidebar:
    st.markdown("### ğŸ“œ ì±„íŒ… ë‚´ì—­")
    if st.session_state.get("messages"):
        for idx, message in enumerate(st.session_state.messages):
            with st.container():
                if message["role"] == "user":
                    st.markdown(f"**ë‚˜**: {message['content'][:50]}...")
                else:
                    st.markdown(f"**Gemini**: {message['content'][:50]}...")
                if st.button(f"ëŒ€í™” {idx+1} ë³´ê¸°", key=f"history_{idx}"):
                    st.session_state.selected_message = message
                    # st.rerun() ì œê±°: ì„ íƒëœ ë©”ì‹œì§€ í‘œì‹œë¥¼ ë©”ì¸ í™”ë©´ì—ì„œ ì²˜ë¦¬
                st.markdown("---")
    else:
        st.markdown("ì•„ì§ ëŒ€í™” ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.")

# --- ë©”ì¸ ì•± ---
st.title("ğŸš€ Chat with Gemini")

# ì´ˆê¸° ì„¤ì •
if "messages" not in st.session_state:
    st.session_state.messages = []
if "chat_history" not in st.session_state:
    st.session_state.chat_history = []
if "system_language" not in st.session_state:
    st.session_state.system_language = "ko"
if "uploaded_images" not in st.session_state:
    st.session_state.uploaded_images = []
if "welcome_dismissed" not in st.session_state:
    st.session_state.welcome_dismissed = False

# Gemini ëª¨ë¸ ì´ˆê¸°í™”
system_prompt = get_system_prompt(st.session_state.system_language)
model = genai.GenerativeModel('gemini-2.5-flash', system_instruction=system_prompt)

# ì²« ë°©ë¬¸ ì‹œ í™˜ì˜ ë©”ì‹œì§€
if not st.session_state.messages and not st.session_state.welcome_dismissed:
    st.markdown("""
    <div style="text-align: center; margin: 20px 0;">
       
    </div>
    """, unsafe_allow_html=True)
    
    col1, col2, col3, col4, col5 = st.columns(5)
    with col1:
        if st.button("ğŸŒ ì›¹í˜ì´ì§€ ìš”ì•½ ì˜ˆì‹œ", use_container_width=True):
            st.session_state.example_input = "https://www.google.com ì´ ì‚¬ì´íŠ¸ì— ëŒ€í•´ ì„¤ëª…í•´ì¤˜"
    with col2:
        if st.button("ğŸ“º ìœ íŠœë¸Œ ìš”ì•½ ì˜ˆì‹œ", use_container_width=True):
            st.session_state.example_input = "https://www.youtube.com/watch?v=dQw4w9WgXcQ ì´ ì˜ìƒ ìš”ì•½í•´ì¤˜"
    with col3:
        if st.button("ğŸ“„ PDF ë…¼ë¬¸ ìš”ì•½ ì˜ˆì‹œ", use_container_width=True):
            st.session_state.example_input = "https://arxiv.org/pdf/2410.04064 ìš”ì•½í•´ì¤˜"
    with col4:
        if st.button("ğŸ–¼ï¸ ì´ë¯¸ì§€ ë¶„ì„ ì˜ˆì‹œ", use_container_width=True):
            st.session_state.example_input = "ì´ë¯¸ì§€ë¥¼ ë¶„ì„í•´ì¤˜"
    with col5:
        if st.button("ğŸ’¬ ì¼ìƒëŒ€í™” ì˜ˆì‹œ", use_container_width=True):
            st.session_state.example_input = "ì˜¤ëŠ˜ ê¸°ë¶„ì´ ì–´ë•Œ?"

    if "example_input" in st.session_state:
        st.info(f"ğŸ’¡ ì˜ˆì‹œ ì…ë ¥: {st.session_state.example_input}")
        st.markdown("ì•„ë˜ ì±„íŒ… ì…ë ¥ì°½ì— ì§ì ‘ ì…ë ¥í•´ë³´ì„¸ìš”!")
        del st.session_state.example_input
    
    # if st.button("í™˜ì˜ ë©”ì‹œì§€ ë‹«ê¸°"):
    #     st.session_state.welcome_dismissed = True

# ì±„íŒ… ê¸°ë¡ í‘œì‹œ (ë©”ì¸ ì±„íŒ… ì˜ì—­)
chat_container = st.container()
with chat_container:
    if "selected_message" in st.session_state:
        message = st.session_state.selected_message
        with st.chat_message(message["role"]):
            st.markdown(message["content"])
            if "images" in message and message["images"]:
                cols = st.columns(min(3, len(message["images"])))
                for idx, img_data in enumerate(message["images"]):
                    with cols[idx % 3]:
                        img = Image.open(io.BytesIO(img_data))
                        st.image(img, caption=f"ì´ë¯¸ì§€ {idx+1}", use_container_width=True)
        if st.button("ì „ì²´ ëŒ€í™” ë³´ê¸°"):
            del st.session_state.selected_message  # ì„ íƒ í•´ì œ
    else:
        for message in st.session_state.messages:
            with st.chat_message(message["role"]):
                st.markdown(message["content"])
                if "images" in message and message["images"]:
                    cols = st.columns(min(3, len(message["images"])))
                    for idx, img_data in enumerate(message["images"]):
                        with cols[idx % 3]:
                            img = Image.open(io.BytesIO(img_data))
                            st.image(img, caption=f"ì´ë¯¸ì§€ {idx+1}", use_container_width=True)

# í•˜ë‹¨ ê³ ì • ì…ë ¥ ì˜ì—­
st.markdown("---")

# ì´ë¯¸ì§€ ì—…ë¡œë“œ ì˜ì—­
with st.expander("ğŸ“ ì´ë¯¸ì§€ ì²¨ë¶€", expanded=False):
    uploaded_files = st.file_uploader(
        "ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ì—¬ ë¶„ì„í•´ë³´ì„¸ìš”",
        type=['png', 'jpg', 'jpeg', 'webp'],
        accept_multiple_files=True,
        key="chat_image_uploader",
        help="ì´ë¯¸ì§€ë¥¼ ë¶„ì„í•˜ê³  ì‹¶ë‹¤ë©´ ì—¬ê¸°ì— ì—…ë¡œë“œí•˜ì„¸ìš”"
    )
    if uploaded_files:
        st.session_state.uploaded_images = uploaded_files
        st.success(f"ğŸ“¸ {len(uploaded_files)}ê°œ ì´ë¯¸ì§€ê°€ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤!")
        cols = st.columns(min(4, len(uploaded_files)))
        for idx, img_file in enumerate(uploaded_files):
            with cols[idx % 4]:
                img = Image.open(img_file)
                st.image(img, caption=f"ì´ë¯¸ì§€ {idx+1}", use_container_width=True)

# ë©”ì¸ ì±„íŒ… ì…ë ¥ì°½
user_input = st.chat_input("ğŸ’¬ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.")

# ì±„íŒ… ì…ë ¥ ì²˜ë¦¬
if user_input:
    detected_lang = detect_language(user_input)
    if detected_lang != st.session_state.system_language:
        st.session_state.system_language = detected_lang
        system_prompt = get_system_prompt(detected_lang)
        model = genai.GenerativeModel('gemini-2.5-flash', system_instruction=system_prompt)
        st.session_state.chat_history = []
        lang_change_msg = "ì–¸ì–´ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤. ëŒ€í™”ë¥¼ ìƒˆë¡œ ì‹œì‘í•©ë‹ˆë‹¤." if detected_lang == "ko" else "Language changed. Starting a new conversation."
        st.session_state.messages.append({"role": "assistant", "content": lang_change_msg})

    if get_usage_count() >= 100:
        st.error("âš ï¸ ì¼ì¼ ë¬´ë£Œ í•œë„ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤!")
    else:
        increment_usage()
        image_data = []
        if st.session_state.uploaded_images:
            for img_file in st.session_state.uploaded_images:
                valid, msg = validate_image_file(img_file)
                if not valid:
                    st.error(msg)
                    continue
                img_file.seek(0)
                image_data.append(img_file.read())
        
        st.session_state.messages.append({
            "role": "user",
            "content": user_input,
            "images": image_data
        })
        
        is_youtube_request, youtube_url = is_youtube_summarization_request(user_input)
        is_webpage_request, webpage_url = is_url_summarization_request(user_input)
        is_pdf_request, pdf_url = is_pdf_summarization_request(user_input)
        has_images = len(st.session_state.uploaded_images) > 0
        is_image_analysis = is_image_analysis_request(user_input, has_images)
        
        with st.status("ğŸ¤– ìš”ì²­ì„ ì²˜ë¦¬í•˜ëŠ” ì¤‘...", expanded=True) as status:
            if is_youtube_request:
                status.update(label="ğŸ“º ìœ íŠœë¸Œ ìë§‰ì„ ê°€ì ¸ì˜¤ëŠ” ì¤‘...")
                response = summarize_youtube_with_gemini(youtube_url, user_input, model, detected_lang)
            elif is_webpage_request:
                status.update(label="ğŸŒ ì›¹í˜ì´ì§€ ë‚´ìš©ì„ ê°€ì ¸ì˜¤ëŠ” ì¤‘...")
                response = summarize_webpage_with_gemini(webpage_url, user_input, model, detected_lang)
            elif is_pdf_request:
                status.update(label="ğŸ“„ PDF ë‚´ìš©ì„ ê°€ì ¸ì˜¤ëŠ” ì¤‘...")
                response = summarize_pdf_with_gemini(pdf_url, user_input, model, detected_lang)
            elif is_image_analysis and has_images:
                status.update(label="ğŸ“¸ ì´ë¯¸ì§€ë¥¼ ë¶„ì„í•˜ëŠ” ì¤‘...")
                images = [process_image_for_gemini(img) for img in st.session_state.uploaded_images]
                if all(img is not None for img in images):
                    chat_session = model.start_chat(history=[])
                    response = analyze_image_with_gemini(images, user_input, chat_session, detected_lang)
                else:
                    response = "âŒ ì´ë¯¸ì§€ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."
            else:
                status.update(label="ğŸ’¬ ì‘ë‹µì„ ìƒì„±í•˜ëŠ” ì¤‘...")
                chat_session = model.start_chat(history=st.session_state.chat_history)
                response = chat_session.send_message(user_input).text
                st.session_state.chat_history = chat_session.history
            status.update(label="âœ… ì™„ë£Œ!", state="complete")
        
        st.session_state.messages.append({"role": "assistant", "content": response})
        st.session_state.uploaded_images = []
        st.rerun()

# í•˜ë‹¨ íŒ
# st.markdown("""
# <div style="text-align: center; color: #666; font-size: 14px; margin-top: 10px; padding: 10px; background-color: #f8f9fa; border-radius: 5px;">
#     ğŸ’¡ <strong>íŒ:</strong> URLì„ ë¶™ì—¬ë„£ê³  'ìš”ì•½í•´ì¤˜', ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ê³  'ë¶„ì„í•´ì¤˜', ë˜ëŠ” ììœ ë¡­ê²Œ ì§ˆë¬¸í•´ë³´ì„¸ìš”!
# </div>
""", unsafe_allow_html=True)